# SQL Validation Tests for OED Data API

This test suite is designed to verify that the SQL queries generated by the API endpoints are correct.

## Overview

The API provides read-only access to enzyme kinetic data through several endpoints:

1. `/api/v1/data` - Main endpoint for querying data with filters
2. `/api/v1/metadata` - Endpoint for getting distinct values for columns

These tests verify that the SQL queries generated by these endpoints are correctly structured based on the provided query parameters.

## Test Structure

- **SQL Generation Tests**: Directly test the SQL generation functions
  - `test_data_sql.py`: Tests SQL generation for various filter combinations
  - `test_metadata_sql.py`: Tests SQL generation for metadata retrieval

- **API Integration Tests**: Test the endpoints through the FastAPI test client
  - `test_api_integration.py`: End-to-end tests for the API using a mock database

## Testing Approach

These tests use a mock database that captures SQL queries without actually executing them against a real database. This approach:

1. Is faster and more reliable than using a real database
2. Focuses specifically on SQL query structure
3. Doesn't require database setup/teardown
4. Avoids issues with test data being modified

## Running the Tests

To run all tests:

```bash
uv run pytest
```

To run a specific test file:

```bash
uv run pytest tests/test_data_sql.py
```

To run a specific test:

```bash
uv run pytest tests/test_data_sql.py::test_string_filter_sql -v
```

To see the SQL queries captured during tests, add the following to a test:

```bash
uv run pytest -s
```

## Test Cases

### Data Endpoint Tests

- **Basic Queries**: Simple queries without filters
- **Column Selection**: Selecting specific columns from the data
- **String Filters**: Filtering on string columns (case-insensitive)
- **EC Number Wildcards**: Special EC number wildcard filtering
- **Numeric Range Filters**: Filtering on numeric ranges (min/max)
- **Pagination**: Limiting and offsetting results
- **Complex Filters**: Combinations of multiple filter types
- **Response Formats**: JSON and CSV output formats

### Metadata Endpoint Tests

- **Column Values**: Getting distinct values for each column
- **Invalid Columns**: Handling invalid column names

## Future Improvements

Possible improvements to these tests could include:

1. Testing SQL syntax correctness by adding a simplified database schema for testing
2. Performance testing for complex SQL queries
3. Testing with a wider range of filter combinations
4. Adding benchmarks for SQL generation speed
